import React, { FC, useEffect, useState } from 'react'

import { Breadcrumbs, ResultTable, ServiceButton } from 'shared/components'
import { useAppSelector } from 'store'

import { breadcrumbs, headers } from './constants'
import s from '../SFCAnalyseResult/SFCAnalyseResult.module.scss'
import { api } from '../../../api'


const VulnerabilityFormationResult: FC = () => {
  const [items, setItems] = useState<string[][] | null>(null)

  const results = useAppSelector(state => state.vulnService.result)


  useEffect(() => {
    if (!results) return
    const parsedItems: string[][] = []
    results.forEach((value) => {
      const cells = [
        value.name || '-',
        value.version || '-',
        value.sfc_type?.name || '-',
        value.vulnerabilities.map(v => v.name).join(', ')
      ]
      parsedItems.push(cells)
    })
    setItems(parsedItems)
  }, [results])

  const downloadHandler = () => {
    api.get<BlobPart>('/sfc/characteristics/my/file-xlsx', {
      responseType: 'arraybuffer'
    }).then((result) => {
      const resultFileBlob = new Blob([result.data], {
        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      })
      const link = document.createElement('a')
      link.href = URL.createObjectURL(resultFileBlob)
      link.style.display = 'none'
      link.download = 'result'
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
    }).catch(e => console.log(e))
  }

  return (
    <>
      <Breadcrumbs breadcrumbs={breadcrumbs} />
      <h2 className={s.title}> Сервис формирования перечня уязвимостей - результат</h2>
      <div className={s.tableContainer}>
        {items && <ResultTable headers={headers} items={items} />}
        {items && <ServiceButton
          buttonTitle={'Сохранить на устройстве'}
          buttonOnClick={downloadHandler}
        />}
      </div>
    </>
  )
}

export { VulnerabilityFormationResult }
